<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ù†ØµØ© Ø§Ù„ØªØªØ¨Ø¹ ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; transition: filter 0.3s; }
        
        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ø´Ø§Ù…Ù„ */
        .emergency-active { animation: flash-red 0.5s infinite; filter: sepia(1) saturate(5) hue-rotate(-50deg); }
        @keyframes flash-red { 0% { background: red; } 50% { background: white; } 100% { background: red; } }

        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        #chat-box {
            position: fixed; bottom: 20px; left: 20px; width: 260px; height: 300px;
            background: rgba(255, 255, 255, 0.9); z-index: 2000; border-radius: 15px;
            display: flex; flex-direction: column; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        #messages { flex: 1; overflow-y: auto; padding: 10px; font-size: 14px; }
        #chat-input-area { display: flex; padding: 10px; border-top: 1px solid #ddd; }
        #chat-input-area input { flex: 1; padding: 5px; border: 1px solid #ccc; border-radius: 5px; }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… */
        .controls { position: fixed; top: 10px; right: 10px; z-index: 2000; display: flex; flex-direction: column; gap: 5px; }
        .btn { padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-sos { background: #ff4444; color: white; }
        .btn-share { background: #44bb44; color: white; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="controls">
    <input type="text" id="userName" placeholder="Ø§Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ..." style="padding:8px; border-radius:5px; border:none;">
    <button class="btn btn-share" onclick="startSharing()">Ø¨Ø« Ù…ÙˆÙ‚Ø¹ÙŠ Ù„Ù„ÙƒÙ„ ğŸ“¡</button>
    <button class="btn btn-sos" onclick="triggerSOS()">ğŸš¨ Ø·ÙˆØ§Ø±Ø¦ SOS</button>
</div>

<div id="chat-box">
    <div style="background:#007bff; color:white; padding:10px; border-radius:15px 15px 0 0; font-weight:bold; text-align:center;">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØ©</div>
    <div id="messages"></div>
    <div id="chat-input-area">
        <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø©...">
        <button onclick="sendMessage()" style="border:none; background:none; cursor:pointer;">â¡ï¸</button>
    </div>
</div>

<audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" loop></audio>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const dbURL = "https://safehome-fd30f-default-rtdb.firebaseio.com/";
    let myName = "";
    let map = L.map('map').setView([32.02, 36.08], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let markers = {};
    let isSharing = false;

    // Ø£ÙŠÙ‚ÙˆÙ†Ø© "Ø§Ù„Ø±Ø¬Ù„" Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¯Ø±Ø§Ø¬Ø©
    const manIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/3063/3063822.png', // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø±Ø¬Ù„ ÙŠÙ…Ø´ÙŠ
        iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40]
    });

    function startSharing() {
        myName = document.getElementById('userName').value;
        if (!myName) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹!");
        isSharing = true;
        navigator.geolocation.watchPosition(pos => {
            if (!isSharing) return;
            fetch(`${dbURL}users/${myName}.json`, {
                method: 'PUT',
                body: JSON.stringify({ lat: pos.coords.latitude, lng: pos.coords.longitude, time: new Date().toLocaleTimeString(), sos: false })
            });
        }, null, { enableHighAccuracy: true });
    }

    function triggerSOS() {
        if (!myName) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ ÙˆØ§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø« Ø£ÙˆÙ„Ø§Ù‹!");
        fetch(`${dbURL}global_status.json`, { method: 'PUT', body: JSON.stringify({ emergency: true, by: myName }) });
        fetch(`${dbURL}users/${myName}/sos.json`, { method: 'PUT', body: "true" });
    }

    function sendMessage() {
        const txt = document.getElementById('msgInput').value;
        if (!txt || !myName) return alert("ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ø³Ù… ÙˆÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±Ø³Ø§Ù„Ø©");
        fetch(`${dbURL}chat.json`, {
            method: 'POST',
            body: JSON.stringify({ user: myName, text: txt, time: new Date().toLocaleTimeString() })
        });
        document.getElementById('msgInput').value = "";
    }

    // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù„Ø­Ø¸ÙŠ Ù„Ù„ÙƒÙ„
    setInterval(() => {
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹
        fetch(`${dbURL}users.json`).then(r => r.json()).then(data => {
            if (!data) return;
            Object.keys(data).forEach(u => {
                const pos = [data[u].lat, data[u].lng];
                if (!markers[u]) {
                    markers[u] = L.marker(pos, {icon: manIcon}).addTo(map).bindPopup(u);
                } else {
                    markers[u].setLatLng(pos);
                }
            });
        });

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        fetch(`${dbURL}chat.json?orderBy="$key"&limitToLast=10`).then(r => r.json()).then(data => {
            if (!data) return;
            let html = "";
            Object.values(data).forEach(m => {
                html += `<div><b>${m.user}:</b> ${m.text}</div>`;
            });
            document.getElementById('messages').innerHTML = html;
        });

        // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ø¹Ø§Ù…Ø©
        fetch(`${dbURL}global_status.json`).then(r => r.json()).then(status => {
            if (status && status.emergency) {
                document.body.classList.add('emergency-active');
                document.getElementById('alarmSound').play();
            } else {
                document.body.classList.remove('emergency-active');
                document.getElementById('alarmSound').pause();
            }
        });
    }, 2000);

    // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø§Ù„Ù„Ù…Ø³
    document.addEventListener('click', () => { document.getElementById('alarmSound').play().then(()=>document.getElementById('alarmSound').pause()); }, {once: true});
</script>
</body>
</html>
