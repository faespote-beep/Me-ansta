<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; overflow: hidden; background: #eee; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø´Ø§Ø´Ø© ÙƒØ§Ù…Ù„Ø© Ù„Ù„Ø·ÙˆØ§Ø±Ø¦ */
        #sos-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; pointer-events: none; display: none;
        }
        .emergency #sos-screen { display: block; animation: flash 0.5s infinite; }
        @keyframes flash { 0% { background: rgba(255, 0, 0, 0.6); } 50% { background: transparent; } 100% { background: rgba(255, 0, 0, 0.6); } }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        .top-ui { 
            position: fixed; top: 10px; right: 10px; z-index: 2000; 
            background: white; padding: 8px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); width: 150px;
        }
        
        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© - ØªØµÙ…ÙŠÙ… "Ø¹Ø§Ø¦Ù…" Ù„ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ø¬ÙˆØ§Ù„ */
        .chat-ui {
            position: fixed; bottom: 10px; left: 10px; right: 10px; z-index: 2000;
            display: flex; flex-direction: column; pointer-events: none;
        }
        #msg-box { 
            background: rgba(255,255,255,0.9); height: 100px; overflow-y: auto; 
            border-radius: 10px 10px 0 0; padding: 8px; pointer-events: auto; font-size: 13px;
        }
        .input-row { display: flex; background: white; padding: 5px; border-radius: 0 0 10px 10px; pointer-events: auto; border-top: 1px solid #ddd; }
        #chatInput { flex: 1; border: none; padding: 10px; outline: none; font-size: 14px; }
        .send-btn { background: #007bff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 18px; }

        .btn { width: 100%; padding: 8px; margin-top: 5px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 12px; }
        .btn-sos { background: #ff4444; color: white; }
        .btn-go { background: #28a745; color: white; }
    </style>
</head>
<body>

<div id="sos-screen"></div>
<div id="map"></div>

<div class="top-ui">
    <input type="text" id="uName" placeholder="Ø§Ø³Ù…Ùƒ..." style="width:85%; padding:5px; margin-bottom:5px; border:1px solid #ddd;">
    <button class="btn btn-go" onclick="initUser()">Ø¨Ø« Ù…ÙˆÙ‚Ø¹ÙŠ</button>
    <button class="btn btn-sos" onclick="triggerSOS()">ðŸš¨ Ø·ÙˆØ§Ø±Ø¦</button>
</div>

<div class="chat-ui">
    <div id="msg-box">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„...</div>
    <div class="input-row">
        <input type="text" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ù‡Ù†Ø§...">
        <button class="send-btn" onclick="sendMsg()">âž¤</button>
    </div>
</div>

<audio id="alarm" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" loop></audio>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const db = "https://safehome-fd30f-default-rtdb.firebaseio.com/";
    let map = L.map('map', { zoomControl: false }).setView([32.02, 36.08], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let myName = "";
    let markers = {};
    const manIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/1260/1260271.png', iconSize: [40, 40] });

    function initUser() {
        myName = document.getElementById('uName').value;
        if (!myName) return alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹!");
        document.getElementById('alarm').play().then(() => document.getElementById('alarm').pause());
        navigator.geolocation.watchPosition(p => {
            fetch(`${db}users/${myName}.json`, { method: 'PUT', body: JSON.stringify({ lat: p.coords.latitude, lng: p.coords.longitude, time: new Date().toLocaleTimeString() }) });
        });
    }

    function triggerSOS() {
        if(!myName) return alert("Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
        fetch(`${db}global_emergency.json`, { method: 'PUT', body: JSON.stringify({ active: true, from: myName }) });
        sendMsg("ðŸ†˜ Ø§Ø³ØªØºØ§Ø«Ø© Ø¹Ø§Ø¬Ù„Ø©!");
    }

    function sendMsg() {
        const t = document.getElementById('chatInput').value;
        if (!t || !myName) return;
        fetch(`${db}messages.json`, { method: 'POST', body: JSON.stringify({ user: myName, msg: t }) });
        document.getElementById('chatInput').value = "";
    }

    setInterval(() => {
        fetch(`${db}users.json`).then(r => r.json()).then(data => {
            if (!data) return;
            Object.keys(data).forEach(u => {
                if (!markers[u]) markers[u] = L.marker([data[u].lat, data[u].lng], {icon: manIcon}).addTo(map).bindPopup(u);
                else markers[u].setLatLng([data[u].lat, data[u].lng]);
            });
        });

        fetch(`${db}messages.json?limitToLast=10`).then(r => r.json()).then(data => {
            if (!data) return;
            let h = "";
            Object.values(data).forEach(m => { h += `<div><b>${m.user}:</b> ${m.msg}</div>`; });
            document.getElementById('msg-box').innerHTML = h;
        });

        fetch(`${db}global_emergency.json`).then(r => r.json()).then(s => {
            if (s && s.active) { document.body.classList.add('emergency'); document.getElementById('alarm').play(); }
            else { document.body.classList.remove('emergency'); document.getElementById('alarm').pause(); }
        });
    }, 2000);
</script>
</body>
</html>
