<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #111; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„ÙØ§Ø¦Ù‚ */
        #sos-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; pointer-events: none; display: none;
        }
        .active-emergency #sos-overlay {
            display: block; animation: power-flash 0.3s infinite;
        }
        @keyframes power-flash {
            0% { background: rgba(255, 0, 0, 0.85); }
            50% { background: transparent; }
            100% { background: rgba(255, 0, 0, 0.85); }
        }

        /* ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        .ui-panel { 
            position: fixed; top: 15px; right: 15px; z-index: 2000; 
            background: white; padding: 15px; border-radius: 15px; 
            box-shadow: 0 5px 25px rgba(0,0,0,0.5); width: 190px;
        }
        
        /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© */
        .chat-container {
            position: fixed; bottom: 15px; left: 15px; right: 15px; z-index: 2000;
            display: flex; flex-direction: column;
        }
        #chat-logs { 
            background: rgba(255,255,255,0.95); height: 120px; overflow-y: auto; 
            border-radius: 15px 15px 0 0; padding: 10px; border: 1px solid #ccc; font-size: 13px;
        }
        .input-bar { display: flex; background: white; padding: 8px; border-radius: 0 0 15px 15px; border: 1px solid #ccc; border-top: none; }
        #msgInput { flex: 1; border: none; outline: none; padding: 5px; font-size: 16px; }
        .btn-send { background: #007bff; color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; }

        .btn-action { width: 100%; padding: 12px; margin-top: 8px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .go-live { background: #28a745; color: white; }
        .sos-trigger { background: #d32f2f; color: white; border: 2px solid #fff; }
    </style>
</head>
<body>

<div id="sos-overlay"></div>
<div id="map"></div>

<div class="ui-panel">
    <input type="text" id="uID" placeholder="Ø§Ø³Ù…Ùƒ..." style="width:88%; padding:10px; margin-bottom:10px; border-radius:5px; border:1px solid #ddd;">
    <button class="btn-action go-live" onclick="startTracking()">ğŸš€ Ø¨Ø« ÙˆÙ…Ø³Ø§Ø± (Ø²Ù„Ù…Ø©)</button>
    <button class="btn-action sos-trigger" onclick="triggerSOS()">ğŸš¨ Ù†Ø¯Ø§Ø¡ Ø·ÙˆØ§Ø±Ø¦</button>
</div>

<div class="chat-container">
    <div id="chat-logs">Ø¬Ø§Ù‡Ø² Ù„Ù„Ø±ØµØ¯...</div>
    <div class="input-bar">
        <input type="text" id="msgInput" placeholder="Ø±Ø³Ø§Ù„Ø©...">
        <button class="btn-send" onclick="sendMsg()">â¤</button>
    </div>
</div>

<audio id="sos-audio" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" loop></audio>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const dbPath = "https://safehome-fd30f-default-rtdb.firebaseio.com/";
    let map = L.map('map', {zoomControl: false}).setView([32.02, 36.08], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let myName = "";
    let userMarkers = {};
    let userPaths = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø±ÙƒØ©

    const walkerIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/1260/1260271.png',
        iconSize: [50, 50],
        iconAnchor: [25, 50]
    });

    function startTracking() {
        myName = document.getElementById('uID').value;
        if (!myName) return alert("Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹!");
        
        document.getElementById('sos-audio').play().then(() => document.getElementById('sos-audio').pause());

        navigator.geolocation.watchPosition(p => {
            const lat = p.coords.latitude;
            const lng = p.coords.longitude;
            const time = new Date().toLocaleTimeString('ar-EG');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ
            fetch(`${dbPath}users/${myName}.json`, { 
                method: 'PUT', 
                body: JSON.stringify({ lat, lng, time }) 
            });

            // Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø·Ø© Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            fetch(`${dbPath}paths/${myName}.json`, { 
                method: 'POST', 
                body: JSON.stringify({ lat, lng }) 
            });

        }, (err) => alert("ÙØ¹Ù„ Ø§Ù„Ù€ GPS!"), { enableHighAccuracy: true });
    }

    function triggerSOS() {
        if(!myName) return alert("Ø³Ø¬Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
        fetch(`${dbPath}global_emergency.json`, { method: 'PUT', body: JSON.stringify({ active: true, user: myName }) });
        sendMsg("ğŸ†˜ Ø§Ø³ØªØºØ§Ø«Ø© Ø¹Ø§Ø¬Ù„Ø© Ù…Ù†: " + myName);
    }

    function sendMsg(altText) {
        const text = altText || document.getElementById('msgInput').value;
        if (!text || !myName) return;
        fetch(`${dbPath}messages.json`, { method: 'POST', body: JSON.stringify({ u: myName, m: text }) });
        document.getElementById('msgInput').value = "";
    }

    setInterval(() => {
        // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø²Ù„Ù…Ø© ÙˆÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
        fetch(`${dbPath}users.json`).then(r => r.json()).then(data => {
            if (!data) return;
            Object.keys(data).forEach(u => {
                if (!userMarkers[u]) {
                    userMarkers[u] = L.marker([data[u].lat, data[u].lng], {icon: walkerIcon}).addTo(map)
                        .bindPopup(`<b>${u}</b><br>Ø¯Ø®Ù„ Ø§Ù„Ø³Ø§Ø¹Ø©: ${data[u].time}`);
                } else {
                    userMarkers[u].setLatLng([data[u].lat, data[u].lng]);
                }
            });
        });

        // 2. ØªØ­Ø¯ÙŠØ« Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø±ÙƒØ© (Ø§Ù„Ø®Ø·ÙˆØ·)
        fetch(`${dbPath}paths.json`).then(r => r.json()).then(data => {
            if (!data) return;
            Object.keys(data).forEach(u => {
                const points = Object.values(data[u]).map(p => [p.lat, p.lng]);
                if (!userPaths[u]) {
                    userPaths[u] = L.polyline(points, {color: '#007bff', weight: 3, opacity: 0.6}).addTo(map);
                } else {
                    userPaths[u].setLatLngs(points);
                }
            });
        });

        // 3. Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
        fetch(`${dbPath}messages.json?limitToLast=8`).then(r => r.json()).then(data => {
            if (!data) return;
            let log = "";
            Object.values(data).forEach(m => { log += `<div><b>${m.u}:</b> ${m.m}</div>`; });
            document.getElementById('chat-logs').innerHTML = log;
        });

        // 4. Ø§Ù„ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø£Ø­Ù…Ø±
        fetch(`${dbPath}global_emergency.json`).then(r => r.json()).then(sos => {
            if (sos && sos.active) {
                document.body.classList.add('active-emergency');
                document.getElementById('sos-audio').play();
            } else {
                document.body.classList.remove('active-emergency');
                document.getElementById('sos-audio').pause();
            }
        });
    }, 2000);
</script>
</body>
</html>
