<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ù…Ù†ØµØ© Ø§Ù„Ø±Ø§Ø¯Ø§Ø± ÙˆØ§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* ØªØµÙ…ÙŠÙ… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ */
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; background-color: #1a1a1a; }
        #map { height: 100vh; width: 100%; z-index: 1; filter: contrast(1.1); }

        /* ØªØ£Ø«ÙŠØ± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ù‚ÙˆÙŠ (ÙˆÙ…ÙŠØ¶ Ø£Ø­Ù…Ø± Ø¬Ø¨Ø§Ø±) */
        #emergency-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 9999; pointer-events: none; display: none;
            box-shadow: inset 0 0 100px #ff0000;
        }
        .sos-active #emergency-screen {
            display: block; animation: power-flash 0.3s infinite;
        }
        @keyframes power-flash {
            0% { background: rgba(255, 0, 0, 0.8); }
            50% { background: transparent; }
            100% { background: rgba(255, 0, 0, 0.8); }
        }

        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¹Ù„ÙˆÙŠØ© */
        .control-panel { 
            position: fixed; top: 15px; right: 15px; z-index: 2000; 
            background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 200px; backdrop-filter: blur(5px);
            border: 2px solid #007bff;
        }
        
        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø·ÙˆØ± */
        .chat-hub {
            position: fixed; bottom: 15px; left: 15px; right: 15px; z-index: 2000;
            display: flex; flex-direction: column; max-height: 40%;
        }
        #chat-window { 
            background: rgba(255, 255, 255, 0.9); border-radius: 15px 15px 0 0; 
            padding: 12px; overflow-y: auto; flex-grow: 1; height: 150px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2); border: 1px solid #ddd;
        }
        .typing-area { 
            display: flex; background: #fff; padding: 10px; 
            border-radius: 0 0 15px 15px; border: 1px solid #ddd; border-top: none;
            align-items: center;
        }
        #msgInput { flex: 1; border: none; outline: none; font-size: 16px; padding: 5px; }
        .send-btn-icon { 
            background: #007bff; color: white; border: none; border-radius: 50%; 
            width: 45px; height: 45px; cursor: pointer; display: flex; 
            align-items: center; justify-content: center; font-size: 20px;
            transition: transform 0.2s;
        }
        .send-btn-icon:active { transform: scale(0.9); }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .main-btn { width: 100%; padding: 12px; margin-top: 8px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-start { background: #28a745; color: white; }
        .btn-sos-global { background: #dc3545; color: white; font-size: 16px; border: 2px solid #fff; }
        
        /* Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„ØµØºÙŠØ± */
        #user-counter { font-size: 12px; color: #555; margin-top: 5px; text-align: center; }
    </style>
</head>
<body>

<div id="emergency-screen"></div>
<div id="map"></div>

<div class="control-panel">
    <h3 style="margin: 0 0 10px 0; font-size: 16px; color: #007bff; text-align: center;">ğŸ›°ï¸ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ</h3>
    <input type="text" id="userName" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§..." style="width: 90%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; outline: none;">
    <button class="main-btn btn-start" onclick="activateGPS()">ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</button>
    <button class="main-btn btn-sos-global" onclick="triggerGlobalSOS()">ğŸš¨ Ø§Ø³ØªØºØ§Ø«Ø© Ø¹Ø§Ø¬Ù„Ø© (SOS)</button>
    <div id="user-counter">Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<div class="chat-hub">
    <div id="chat-window">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ ÙˆØ´ØºÙ„ Ø§Ù„Ø¨Ø« Ù„Ù„Ø¨Ø¯Ø¡..</div>
    <div class="typing-area">
        <input type="text" id="msgInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹...">
        <button class="send-btn-icon" onclick="pushMessage()">â¤</button>
    </div>
</div>

<audio id="sos-audio" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" loop></audio>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const FIREBASE_DB = "https://safehome-fd30f-default-rtdb.firebaseio.com/";
    let myIdentity = "";
    let activeMarkers = {};

    // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø±Ø¬Ù„ Ø§Ù„Ø°ÙŠ ÙŠÙ…Ø´ÙŠ (Walker Icon)
    const walkerIcon = L.icon({
        iconUrl: 'https://cdn-icons-png.flaticon.com/512/1260/1260271.png',
        iconSize: [50, 50],
        iconAnchor: [25, 50],
        popupAnchor: [0, -50]
    });

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
    let map = L.map('map', { zoomControl: false }).setView([32.02, 36.08], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function activateGPS() {
        myIdentity = document.getElementById('userName').value;
        if (!myIdentity) return alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹ Ù„ÙƒÙŠ ÙŠØ±Ø§Ùƒ Ø§Ù„Ø¢Ø®Ø±ÙˆÙ†!");

        // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù„Ù„Ù…ØªØµÙØ­
        document.getElementById('sos-audio').play().then(() => document.getElementById('sos-audio').pause());

        navigator.geolocation.watchPosition(pos => {
            const coords = { 
                lat: pos.coords.latitude, 
                lng: pos.coords.longitude, 
                time: new Date().toLocaleTimeString() 
            };
            fetch(`${FIREBASE_DB}users/${myIdentity}.json`, { method: 'PUT', body: JSON.stringify(coords) });
        }, err => {
            alert("Ø®Ø·Ø£: ÙŠØ±Ø¬Ù‰ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù€ GPS ÙÙŠ Ø§Ù„Ù‡Ø§ØªÙ ÙˆØ§Ù„Ø³Ù…Ø§Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù…ÙˆÙ‚Ø¹Ùƒ.");
        }, { enableHighAccuracy: true });
    }

    function triggerGlobalSOS() {
        if (!myIdentity) return alert("Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø£ÙˆÙ„Ø§Ù‹!");
        fetch(`${FIREBASE_DB}global_emergency.json`, { method: 'PUT', body: JSON.stringify({ active: true, owner: myIdentity }) });
        pushMessage("ğŸ†˜ğŸ†˜ Ù†Ø¯Ø§Ø¡ Ø·ÙˆØ§Ø±Ø¦ Ø¹Ø§Ø¬Ù„! Ø£Ù†Ø§ ÙÙŠ Ø®Ø·Ø±! ğŸ†˜ğŸ†˜");
    }

    function pushMessage(text) {
        const messageText = text || document.getElementById('msgInput').value;
        if (!messageText || !myIdentity) return;
        fetch(`${FIREBASE_DB}messages.json`, { 
            method: 'POST', 
            body: JSON.stringify({ user: myIdentity, msg: messageText, timestamp: Date.now() }) 
        });
        document.getElementById('msgInput').value = "";
    }

    // Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ (ÙƒÙ„ 1.5 Ø«Ø§Ù†ÙŠØ©)
    setInterval(() => {
        // 1. ØªØ­Ø¯ÙŠØ« Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ø±Ø¬Ù„ ÙŠÙ…Ø´ÙŠ)
        fetch(`${FIREBASE_DB}users.json`).then(r => r.json()).then(data => {
            if (!data) return;
            document.getElementById('user-counter').innerText = "Ø§Ù„Ù…ØªØµÙ„ÙˆÙ† Ø§Ù„Ø¢Ù†: " + Object.keys(data).length;
            Object.keys(data).forEach(user => {
                if (!activeMarkers[user]) {
                    activeMarkers[user] = L.marker([data[user].lat, data[user].lng], {icon: walkerIcon}).addTo(map).bindPopup("<b>" + user + "</b><br>ØªØ­Ø¯ÙŠØ«: " + data[user].time);
                } else {
                    activeMarkers[user].setLatLng([data[user].lat, data[user].lng]);
                }
            });
        });

        // 2. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©
        fetch(`${FIREBASE_DB}messages.json?limitToLast=10`).then(r => r.json()).then(data => {
            if (!data) return;
            let logHtml = "";
            Object.values(data).sort((a,b) => a.timestamp - b.timestamp).forEach(m => {
                logHtml += `<div style="margin-bottom:8px;"><b>${m.user}:</b> ${m.msg}</div>`;
            });
            const win = document.getElementById('chat-window');
            win.innerHTML = logHtml;
            win.scrollTop = win.scrollHeight;
        });

        // 3. Ù†Ø¸Ø§Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ø´Ø§Ù…Ù„ (Ø§Ù„ÙˆÙ…ÙŠØ¶ Ø§Ù„Ù‚ÙˆÙŠ)
        fetch(`${FIREBASE_DB}global_emergency.json`).then(r => r.json()).then(sos => {
            if (sos && sos.active) {
                document.body.classList.add('sos-active');
                document.getElementById('sos-audio').play();
            } else {
                document.body.classList.remove('sos-active');
                document.getElementById('sos-audio').pause();
            }
        });
    }, 1500);
</script>
</body>
</html>
