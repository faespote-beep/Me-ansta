<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ù…Ø·ÙˆØ±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; transition: background 0.5s; }
        #map { height: 100vh; width: 100%; }
        .control-panel { position: fixed; top: 10px; right: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .sos-alert { background: red !important; animation: emergency 0.5s infinite; }
        @keyframes emergency { 0% { background: red; } 50% { background: white; } 100% { background: red; } }
        #emergencyMsg { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 2000; background: red; color: white; padding: 30px; border-radius: 20px; font-size: 30px; font-weight: bold; text-align: center; border: 5px solid white; }
    </style>
</head>
<body>

    <div id="emergencyMsg">ğŸš¨ Ù†Ø¯Ø§Ø¡ Ø§Ø³ØªØºØ§Ø«Ø© Ø¹Ø§Ø¬Ù„! ğŸš¨<br><span id="sosStudent"></span> ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©!</div>

    <div class="control-panel">
        <b>Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨</b>
        <div id="studentList">Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>

    <div id="map"></div>
    <audio id="beep" src="https://www.soundjay.com/buttons/beep-07a.mp3"></audio>
    <audio id="alarm" src="https://www.soundjay.com/buttons/button-4.mp3" loop></audio>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        var map = L.map('map').setView([32.02, 36.08], 15);
        var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
        
        var baseMaps = { "Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø´ÙˆØ§Ø±Ø¹": streetLayer, "Ø£Ù‚Ù…Ø§Ø± ØµÙ†Ø§Ø¹ÙŠØ©": satelliteLayer };
        L.control.layers(baseMaps).addTo(map);

        var students = {};
        var studentIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3063/3063822.png',
            iconSize: [40, 40], iconAnchor: [20, 40]
        });

        function updateData() {
            fetch("https://safehome-fd30f-default-rtdb.firebaseio.com/students.json")
            .then(res => res.json())
            .then(data => {
                if (!data) return;
                
                let anySos = false;
                let listHtml = "";
                
                Object.keys(data).forEach(name => {
                    let s = data[name];
                    let pos = [s.lat, s.lng];
                    listHtml += `<div>ğŸ“ ${name} (${s.time}) ${s.sos ? 'ğŸš¨' : ''}</div>`;

                    if (s.sos) {
                        anySos = true;
                        document.getElementById('sosStudent').innerText = name;
                    }

                    if (!students[name]) {
                        students[name] = {
                            marker: L.marker(pos, {icon: studentIcon}).addTo(map).bindPopup(name),
                            path: L.polyline([pos], {color: 'blue', weight: 3}).addTo(map)
                        };
                    } else {
                        students[name].marker.setLatLng(pos);
                        students[name].path.addLatLng(pos);
                    }
                });

                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
                if (anySos) {
                    document.body.classList.add('sos-alert');
                    document.getElementById('emergencyMsg').style.display = 'block';
                    document.getElementById('alarm').play();
                } else {
                    document.body.classList.remove('sos-alert');
                    document.getElementById('emergencyMsg').style.display = 'none';
                    document.getElementById('alarm').pause();
                }

                document.getElementById('studentList').innerHTML = listHtml;
            });
        }

        setInterval(updateData, 2000);
        map.on('click', () => { 
            document.getElementById('beep').play(); 
            document.getElementById('alarm').pause(); // Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ù†Ø°Ø§Ø± ÙŠØ¯ÙˆÙŠØ§Ù‹
        });
    </script>
</body>
</html>
