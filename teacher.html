<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ - Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; transition: background 0.3s; }
        #map { height: 100vh; width: 100%; z-index: 1; }
        
        /* Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© */
        .control-panel { 
            position: fixed; top: 10px; right: 10px; z-index: 1000; 
            background: rgba(255, 255, 255, 0.9); padding: 15px; 
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); 
            max-width: 200px;
        }
        .status-item { margin-bottom: 8px; font-size: 14px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        
        /* ØªØ£Ø«ÙŠØ± ÙˆÙ…ÙŠØ¶ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ù„Ù„Ø´Ø§Ø´Ø© */
        .sos-alert-active { animation: emergency-bg 0.5s infinite; }
        @keyframes emergency-bg { 
            0% { background: #ff0000; } 50% { background: #ffffff; } 100% { background: #ff0000; } 
        }

        /* Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø§Ù„ÙƒØ¨ÙŠØ±Ø© */
        #emergencyOverlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 0, 0, 0.7); color: white; z-index: 2000;
            flex-direction: column; align-items: center; justify-content: center;
            font-size: 32px; font-weight: bold; text-align: center;
        }
        #emergencyOverlay button {
            margin-top: 20px; padding: 10px 30px; font-size: 18px; 
            background: white; border: none; border-radius: 5px; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="emergencyOverlay">
        <div id="sosText">ğŸš¨ Ù†Ø¯Ø§Ø¡ Ø§Ø³ØªØºØ§Ø«Ø© Ø¹Ø§Ø¬Ù„! ğŸš¨</div>
        <button onclick="stopAlarm()">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¥Ù†Ø°Ø§Ø±</button>
    </div>

    <div class="control-panel">
        <b style="color: #d32f2f;">ğŸ“¡ Ø±Ø§Ø¯Ø§Ø± Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</b>
        <hr>
        <div id="studentList">Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨...</div>
    </div>

    <div id="map"></div>

    <audio id="beepSound" src="https://www.soundjay.com/buttons/beep-07a.mp3"></audio>
    <audio id="alarmSound" src="https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg" loop></audio>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø·Ø¨Ù‚Ø§Øª
        var map = L.map('map').setView([32.02, 36.08], 13);
        
        var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
        
        var baseMaps = { "Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø´ÙˆØ§Ø±Ø¹": streetLayer, "Ø£Ù‚Ù…Ø§Ø± ØµÙ†Ø§Ø¹ÙŠØ©": satelliteLayer };
        L.control.layers(baseMaps).addTo(map);

        var students = {}; 
        var audioContextUnlocked = false;

        // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø§Ù„Ø¯Ø±Ø§Ø¬Ø© Ø§Ù„Ø­Ù…Ø±Ø§Ø¡)
        var studentIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3063/3063822.png',
            iconSize: [45, 45], iconAnchor: [22, 45], popupAnchor: [0, -45]
        });

        // 2. ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª Ø¹Ù†Ø¯ Ø£ÙˆÙ„ Ø¶ØºØ·Ø©
        map.on('mousedown touchstart', function() {
            if (!audioContextUnlocked) {
                document.getElementById('beepSound').play().then(() => {
                    document.getElementById('beepSound').pause();
                    audioContextUnlocked = true;
                    console.log("ØªÙ… ØªÙØ¹ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª");
                });
            }
        });

        // 3. ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        function updateRadar() {
            fetch("https://safehome-fd30f-default-rtdb.firebaseio.com/students.json")
            .then(res => res.json())
            .then(data => {
                if (!data) return;
                
                let anySOS = false;
                let listHtml = "";
                let sosNames = [];

                Object.keys(data).forEach(name => {
                    let s = data[name];
                    let pos = [s.lat, s.lng];
                    
                    listHtml += `<div class="status-item">ğŸ‘¤ ${name} <br> ğŸ•’ ${s.time} ${s.sos ? 'ğŸš¨' : ''}</div>`;

                    if (s.sos) {
                        anySOS = true;
                        sosNames.push(name);
                    }

                    if (!students[name]) {
                        // Ø¥Ù†Ø´Ø§Ø¡ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
                        students[name] = {
                            marker: L.marker(pos, {icon: studentIcon}).addTo(map).bindPopup("<b>" + name + "</b>"),
                            path: L.polyline([pos], {color: '#1a73e8', weight: 4, opacity: 0.6}).addTo(map)
                        };
                        document.getElementById('beepSound').play();
                    } else {
                        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ù…Ø³Ø§Ø±
                        let currentLatLng = students[name].marker.getLatLng();
                        if (currentLatLng.lat !== s.lat || currentLatLng.lng !== s.lng) {
                            students[name].marker.setLatLng(pos);
                            students[name].path.addLatLng(pos);
                        }
                    }
                });

                document.getElementById('studentList').innerHTML = listHtml;

                // 4. Ù†Ø¸Ø§Ù… Ø§Ù„Ø·ÙˆØ§Ø±Ø¦
                if (anySOS) {
                    handleEmergency(sosNames.join(", "));
                } else {
                    stopAlarm();
                }
            });
        }

        function handleEmergency(name) {
            document.body.classList.add('sos-alert-active');
            document.getElementById('emergencyOverlay').style.display = 'flex';
            document.getElementById('sosText').innerHTML = `ğŸš¨ Ù†Ø¯Ø§Ø¡ Ø§Ø³ØªØºØ§Ø«Ø© Ø¹Ø§Ø¬Ù„! ğŸš¨<br>${name} ÙŠØ­ØªØ§Ø¬ Ù…Ø³Ø§Ø¹Ø¯Ø©!`;
            document.getElementById('alarmSound').play();
        }

        function stopAlarm() {
            document.body.classList.remove('sos-alert-active');
            document.getElementById('emergencyOverlay').style.display = 'none';
            document.getElementById('alarmSound').pause();
            document.getElementById('alarmSound').currentTime = 0;
        }

        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ Ø«Ø§Ù†ÙŠØªÙŠÙ†
        setInterval(updateRadar, 2000);
    </script>
</body>
</html>
