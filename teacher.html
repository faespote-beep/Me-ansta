<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>Ø±Ø§Ø¯Ø§Ø± Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; }
        #map { height: 100vh; width: 100%; }
        .control-panel { position: fixed; top: 10px; right: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div class="control-panel">
        <b>Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø·Ù„Ø§Ø¨</b>
        <div id="studentList">Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
    </div>

    <div id="map"></div>
    <audio id="beep" src="https://www.soundjay.com/buttons/beep-07a.mp3"></audio>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        var map = L.map('map').setView([32.02, 36.08], 15);
        
        // Ø·Ø¨Ù‚Ø§Øª Ø§Ù„Ø®Ø±ÙŠØ·Ø© (Ø¹Ø§Ø¯ÙŠ + Ø£Ù‚Ù…Ø§Ø± ØµÙ†Ø§Ø¹ÙŠØ©)
        var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
        
        var baseMaps = { "Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø´ÙˆØ§Ø±Ø¹": streetLayer, "Ø£Ù‚Ù…Ø§Ø± ØµÙ†Ø§Ø¹ÙŠØ©": satelliteLayer };
        L.control.layers(baseMaps).addTo(map);

        var students = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ Ø·Ø§Ù„Ø¨ (Marker + Path)

        var studentIcon = L.icon({
            iconUrl: 'https://cdn-icons-png.flaticon.com/512/3063/3063822.png', // Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø´Ø®Øµ ÙŠÙ…Ø´ÙŠ
            iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40]
        });

        function updateData() {
            fetch("https://safehome-fd30f-default-rtdb.firebaseio.com/students.json")
            .then(res => res.json())
            .then(data => {
                if (!data) return;
                
                let listHtml = "";
                Object.keys(data).forEach(name => {
                    let s = data[name];
                    let pos = [s.lat, s.lng];
                    
                    listHtml += `<div>ğŸ“ ${name} (${s.time})</div>`;

                    if (!students[name]) {
                        // Ø¥Ù†Ø´Ø§Ø¡ Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
                        students[name] = {
                            marker: L.marker(pos, {icon: studentIcon}).addTo(map).bindPopup(name),
                            path: L.polyline([pos], {color: 'blue', weight: 3}).addTo(map)
                        };
                        document.getElementById('beep').play().catch(e => {});
                    } else {
                        // ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ±Ø³Ù… Ø§Ù„Ù…Ø³Ø§Ø±
                        let lastPos = students[name].marker.getLatLng();
                        if (lastPos.lat !== s.lat || lastPos.lng !== s.lng) {
                            students[name].marker.setLatLng(pos);
                            students[name].path.addLatLng(pos);
                            document.getElementById('beep').play().catch(e => {});
                        }
                    }
                });
                document.getElementById('studentList').innerHTML = listHtml;
            });
        }

        setInterval(updateData, 2000);
        map.on('click', () => document.getElementById('beep').play()); // Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª
    </script>
</body>
</html>
